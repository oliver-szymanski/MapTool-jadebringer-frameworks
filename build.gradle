/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java Library project to get you started.
 * For more details take a look at the Java Libraries chapter in the Gradle
 * User Manual available at https://docs.gradle.org/5.2.1/userguide/java_library_plugin.html
 */

plugins {
    // Apply the java-library plugin to add support for Java Library
    id 'java-library'
	// Access Git info from build script
    id "org.ajoberstar.grgit" version "3.1.1"
}

apply plugin: 'base'
apply plugin: 'application'
apply plugin: 'java'

mainClassName = 'de.jadebringer.maptool.frameworks.MapToolWrapper'
applicationDefaultJvmArgs = ["-Xss4M"]

import org.ajoberstar.grgit.Grgit

// Custom properties
ext {
    // Get tag and commit info from Git to use for version numbering
    def repo = org.ajoberstar.grgit.Grgit.open(currentDir: file('.'))
    def head = repo.head()
    def tags = repo.tag.list().find {
        it.commit == head
    }

    revision = head.abbreviatedId
    revisionFull = head.id

	if (tags) {
        version = tags.getName()
       	enviroment = "Production"
    } else {
        version = 'SNAPSHOT-' + revision
        enviroment = "Development"
    }

    // vendor, tagVersion defaults are set in gradle.properties
    project.version = version
    println 'Configuring for ' + project.name + " " + project.version + " by " + vendor
    repo.close()
}

task cloneLibrariesFromGit {
   	println "looking for MapTool in directory: " + maptoolDirectory
	def maptoolLib = file(maptoolDirectory)
	if (!maptoolLib.exists()) {
    	println "MapTool directory not found, trying to get from Git (" + maptoolGitRef + " from " + maptoolGitUrl + ")"
    	def grgit = Grgit.clone(dir: file(maptoolDirectory), uri: maptoolGitUrl, bare: false, checkout: true, refToCheckout: maptoolGitRef)
    	println "download finished"
    	grgit.close()
    }
}

task buildFromGit(type: GradleBuild) {
	dependsOn cloneLibrariesFromGit
	println 'trying to build liberary dependency from git: ' + maptoolDirectory+'/build.gradle'
  	buildFile = maptoolDirectory+'/build.gradle'
  	dir = maptoolDirectory
  	tasks = ['build']
}

startScripts {
    dependsOn buildFromGit
}

repositories {
    // Use jcenter for resolving your dependencies.
    // You can declare any Maven/Ivy/file repository here.
	jcenter()
    mavenCentral()
    maven { url = 'http://maptool.craigs-stuff.net/repo/' }
    maven { url = 'http://www.nerps.net/repo/' }
    //maven { url = 'http://nexus.fyiblue.com/content/groups/public' }
    
    //maven { url "https://jitpack.io" }
    mavenLocal()
    
	flatDir {
		dirs maptoolDirectory+'/build/libs', 'lib'
	}
}

dependencies {

    implementation 'net.rptools.parser:parser:1.4.0.+'
    implementation 'net.rptools.decktool:decktool:1.0.b1'
    implementation 'net.rptools.dicelib:dicelib:1.4.0.+'
    implementation 'net.rptools.maptool.resource:maptool.resource:1.0.b18'
    implementation 'net.rptools.parser:parser:1.4.0.+'

    implementation 'jide-common:jide-common:3.2.3'
    implementation 'jide-components:jide-components:3.2.3'
    implementation 'jide-dialogs:jide-dialogs:3.2.3'
    implementation 'jide-dock:jide-dock:3.2.3'
    implementation 'jide-editor:jide-editor:3.2.3'
    implementation 'jide-grids:jide-grids:3.2.3'
    implementation 'jide-properties:jide-properties:3.2.3'
    implementation 'jide-shortcut:jide-shortcut:3.2.3'
    
    implementation 'net.sf.json-lib:json-lib:2.4:jdk15'
    
    implementation 'de.muntjak.tinylookandfeel:tinylaf-nocp:1.4.0'
    
    // For syntax highlighting in macro editor
    implementation group: 'com.fifesoft', name: 'rsyntaxtextarea', version: '3.0.2'		// https://mvnrepository.com/artifact/com.fifesoft/rsyntaxtextarea
    implementation group: 'com.fifesoft', name: 'rstaui', version: '3.0.0'				// https://mvnrepository.com/artifact/com.fifesoft/rstaui
    implementation group: 'com.fifesoft', name: 'autocomplete', version: '3.0.0'		// https://mvnrepository.com/artifact/com.fifesoft/autocomplete

	//implementation ('rptools:MapTool')  {
     //   version {
     //       branch = 'master'
     //   }
    //}
    //compile 'com.github.oliver-szymanski:MapTool:1.5.1-jadebringer'
    //implementation group: 'rptools', name: 'MapTool', version: maptoolGitRef
    //implementation project(":MapTool")
     compile (name:'MapTool', ext:'jar')
    
//    implementation files "MapTool"

}

jar {
    manifest {
        attributes('Implementation-Title': project.name,
                   'Implementation-Version': project.version)
    }
}